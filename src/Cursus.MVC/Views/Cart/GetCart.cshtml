@model IEnumerable<Cursus.Domain.Models.Cart>
@{
    ViewData["Title"] = "Shopping Cart";
   
}

<style>
    ._bg4586 {
        padding: 0px !important;
    }

    .cr1fot {
        float: none !important;
    }

    .original-price {
        font-size: 15px;
        text-decoration: line-through;
        color: green;
    }

    .discounted-price {
        font-size: 15px;
        color: red;
    }

    .price {
        font-size: 15px;
        color: green;
    }
</style>
<!-- Body Start -->
<div class="wrapper _bg4586 _new89">
    <div class="_215b15">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                 
                    <div class="title126">
                        <h2>Shopping Cart</h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="mb4d25">
        <div class="container">
            <div class="row">
                <div class="col-lg-8">
                    @if (Model != null && Model.Any())
                    {
                        @foreach (var item in Model)
                        {
                            <div class="fcrse_1" data-cart-id="@item.CartId" data-course-money="@item.Course.CourseMoney"
                                data-course-discount="@item.Course.Discount">
                                <a asp-action="" asp-controller="" class="hf_img">
                                    <img class="cart_img" src="@item.Course.CourseAvatar" alt="avatar course">
                                </a>
                                <div class="hs_content">
                                    <div class="eps_dots eps_dots10 more_dropdown">
                                        <a><i class='uil uil-times removeCart'></i></a>
                                    </div>
                                    <a href="course_detail_view.html" class="crse14s title900 pt-2">@item.Course.CourseName</a>
                                    <a class="crse-cate">@item.Course.CourseShortDes</a>
                                    <div class="auth1lnkprce">
                                        <p class="cr1fot">By <a>@item.Course.Account.FullName</a></p>
                                        <div>
                                            @if (item.Course.Discount > 0)
                                            {
                                                var discountAmount = (item.Course.Discount / 100) * item.Course.CourseMoney;
                                                var discountedPrice = item.Course.CourseMoney - discountAmount;
                                                <div>
                                                    <span class="original-price">@String.Format("${0:N2}",
                                            @item.Course.CourseMoney)</span>
                                                    <span class="discounted-price">@String.Format("${0:N2}",
                                            discountedPrice).Replace(",", ".")</span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div><span class="price">@String.Format("${0:N2}",
                                                @item.Course.CourseMoney).Replace(",", ".")</span></div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <h4>There are no items in the cart.</h4>
                    }
                </div>
                <div class="col-lg-4">
                    @if (Model != null && Model.Any())
                    {
                        <div class="membership_chk_bg rght1528">
                            <div class="order_dt_section">
                                @if (Model != null && Model.Any())
                                {
                                    <div class="checkout_title">
                                        <h4>Total</h4>
                                        <img src="images/line.svg" alt="">
                                    </div>
                                    decimal discountPriceTotal = 0;
                                    decimal originalPriceTotal = 0;
                                    decimal totalMount = 0;
                                    foreach (var item in Model)
                                    {
                                        decimal courseMoney = item.Course.CourseMoney;
                                        decimal discount = item.Course.Discount.GetValueOrDefault();
                                        decimal realPrice = courseMoney;

                                        if (discount > 0)
                                        {
                                            decimal discountAmount = (discount / 100) * courseMoney;
                                            realPrice = courseMoney - discountAmount;
                                        }

                                        originalPriceTotal += courseMoney;
                                        discountPriceTotal += realPrice;
                                        totalMount += realPrice;
                                    }

                                    <div class="order_title">
                                        <h4>Original Price</h4>
                                        <div class="order_price" id="originalPriceTotal">@String.Format("{0:C}",
                                    originalPriceTotal)</div>
                                    </div>
                                    @if (discountPriceTotal < originalPriceTotal)
                                    {
                                        <div class="order_title">
                                            <h6>Discount Price</h6>
                                            <div class="order_price" id="discountPriceTotal">@String.Format("{0:C}",
                                    discountPriceTotal)</div>
                                        </div>
                                    }
                                    <div class="order_title">
                                        <h2>Total</h2>
                                        <div class="order_price5" id="totalPrice">@String.Format("{0:C}", totalMount)</div>
                                    </div>
                                    <a class="chck-btn22" id="checkoutButton" style="cursor: pointer;">Checkout Now</a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Body End -->

@section scripts {
    <script>
        // ajax remove from the cart
        $(document).ready(function () {
            $(".removeCart").on("click", function () {
                var cartId = $(this).closest(".fcrse_1").data("cart-id");
                var $cartItem = $(this).closest(".fcrse_1");
                var courseMoney = parseFloat($cartItem.data("course-money"));
                var discount = parseFloat($cartItem.data("course-discount"));

                $.ajax({
                    url: "/Cart/RemoveFromCart",
                    type: "POST",
                    data: { cartId: cartId },
                    success: function (data) {
                        if (data !== "Item not found.") {
                            sweetAlertSuccess("The course has been removed from the cart.");
                            $cartItem.remove();
                            document.getElementById("cartCount").innerHTML = data.cartCount.toString();

                            var originalPriceTotal = parseFloat($("#originalPriceTotal").text().replace("$", "").replace(",", ""));
                            var discountPriceTotal = parseFloat($("#discountPriceTotal").text().replace("$", "").replace(",", ""));
                            var totalPrice = parseFloat($("#totalPrice").text().replace("$", "").replace(",", ""));

                            var realPrice = courseMoney;

                            if (discount > 0) {
                                var discountAmount = (discount / 100) * courseMoney;
                                realPrice = courseMoney - discountAmount;
                                discountPriceTotal -= realPrice;
                            } else {
                                discountPriceTotal -= courseMoney;
                            }

                            originalPriceTotal -= courseMoney;
                            totalPrice -= realPrice;

                            // Ensure the totals are not negative
                            originalPriceTotal = Math.max(0, originalPriceTotal);
                            discountPriceTotal = Math.max(0, discountPriceTotal);
                            totalPrice = Math.max(0, totalPrice);

                            $("#originalPriceTotal").text("$" + originalPriceTotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                            $("#discountPriceTotal").text("$" + discountPriceTotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                            $("#totalPrice").text("$" + totalPrice.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                        } else {
                            sweetAlertError("Error removing course from cart.");
                        }
                    },
                    error: function (error) {
                        sweetAlertError("Error adding course to cart.");
                    }
                });
            });
        });
    </script>

    <script>
        $(document).ready(function () {
            $("#checkoutButton").on("click", function (e) {
                e.preventDefault();

                // Confirmation dialog
                if (confirm("Are you sure you want to checkout?")) {
                    $.ajax({
                        url: "/Cart/Checkout",
                        type: "POST",
                        success: function (data) {
                            if (data) {
                                sweetAlertSuccess("Checkout successful!");
                                window.location.href = "/Home/Index";
                            } else {
                                sweetAlertError("Checkout failed. Please try again.");
                            }
                        },
                        error: function () {
                            sweetAlertError("Error occurred during checkout. Insufficient funds, checkout fails!");
                        }
                    });
                }
            });
        });
    </script>
}
